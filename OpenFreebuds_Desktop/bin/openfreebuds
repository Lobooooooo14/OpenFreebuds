#!/usr/bin/env python3
import argparse
import logging
import sys

import openfreebuds_applet
import openfreebuds_backend
from openfreebuds_applet import tools
from openfreebuds_applet.l18n import t

log_format = "%(levelname)s:%(name)s:%(threadName)s  %(message)s"
description = "Unofficial application to manage HUAWEI FreeBuds device"

parser = argparse.ArgumentParser(description=description)
parser.add_argument("--verbose",
                    default=False, action="store_true",
                    help="Print debug log to console")
args = parser.parse_args()


def main():
    version = tools.get_version()
    print("openfreebuds version=" + version)

    setup_logging()
    start_applet()


def start_applet():
    if tools.is_running():
        openfreebuds_backend.show_message(t("application_running_message"),
                                          window_title="OpenFreebuds")
        sys.exit(1)

    openfreebuds_applet.start()


def setup_logging():
    if args.verbose:
        print("Enabled verbose mode")
        logging.basicConfig(level=logging.DEBUG, format=log_format, force=True)
    else:
        logfile = tools.get_log_filename()
        print("Log redirected to file " + logfile +
              ". Set --verbose flag to see logs here.")
        logging.basicConfig(level=logging.DEBUG,
                            format=log_format,
                            filename=logfile)


main()
